<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="node-styles.html">

<dom-module id="yb-node">
  <style include="node-styles"></style>
  <template>
    <template is="dom-if" if="{{!isEditing}}">
      <template is="dom-if" if="{{!name}}" restamp="true">
        <pre class="node-id">{{nodeId_withLinebreaks}}</pre>
      </template>
      <template is="dom-if" if="{{name}}">
        <div id="node-name">{{name}}</div>
      </template>
    </template>
    <input id="input_box" class="hidden" type="text" value="{{name}}" on-blur="onBlur" on-keypress="onKeypress">
  </template>

  <script>
    (function() {
      Polymer({
        is: 'yb-node',
        properties: {
          name: {
            type: String,
            value: '',
          },
          'nodeId': {
            type: String,
          },
          'nodeId_withLinebreaks': {
            type: String,
            computed: 'getNodeId_withLinebreaks(nodeId)'
          },
          highlighted: {
            type: Boolean,
            value: false,
            observer: 'handleHighlightedChanged',
          },
          selected: {
            type: Boolean,
            value: false,
            observer: 'handleSelectedChanged',
          },
          isEditing: {
            type: Boolean,
            value: false,
          },
        },
        getNodeId_withLinebreaks: function() {
          return this.nodeId.slice(0, 8) + '\n' +
                 this.nodeId.slice(8, 8 + 8) + '\n' +
                 this.nodeId.slice(8 + 8, 8 + 8 + 8) + '\n' +
                 this.nodeId.slice(8 + 8 + 8);
        },
        created: function() {
        
          var self = this;
          
          self.dimensions = {
            width:  null,
            height: null,
          }
          
          self.connectorsFrom = new Set();
          self.connectorsVia  = new Set();
          self.connectorsTo   = new Set();
          
          require(['core/client', 'core/node_id'], function(client, node_id) {
          
            self.client = client;
            self.id_ = node_id.fromHex(self.nodeId);
            if (client.web.hasName(self.id_)) {
              self.set('name', client.web.getName(self.id_));
            }
            
            self.widgetId = node_id.make();
            
            client.web.onNames(function(namesAdded, namesRemoved) {
              namesAdded.forEach(function(node) {
                if (node_id.equal(node.id, self.id_)) {
                  self.set('name', node.name);
                  self.updateStyles();
                  self.updateDimensions();
                }
              });
              namesRemoved.forEach(function(node) {
                if (node_id.equal(node, self.id_)) {
                  self.set('name', '');
                  self.updateStyles();
                  self.updateDimensions();
                }
              });
            });
          });
        },
        ready: function() {
          this.widgetHandle = this;
        },
        attached: function() {
          this.fire('widgetAttached', this);
        },
        detached: function() {
//           this.fire('widgetDetached', this);
        },
        connectors: function() {
          var connectors = new Set();
          this.connectorsFrom.forEach(function(connector) { connectors.add(connector); });
          this.connectorsVia.forEach(function(connector)  { connectors.add(connector); });
          this.connectorsTo.forEach(function(connector)   { connectors.add(connector); });
          return connectors;
        },
        handleHighlightedChanged: function() {
          this.toggleClass('highlighted', this.highlighted);
        },
        handleSelectedChanged: function() {
          this.toggleClass('selected', this.selected);
        },
        updateDimensions: function() {
          Polymer.dom.flush();
          var rect = this.getBoundingClientRect();
          if (this.dimensions.width  !== rect.width ||
              this.dimensions.height !== rect.height) {
            this.set('dimensions', {
              width:  rect.width,
              height: rect.height,
            });
            this.fire('dimensionsChanged', this.dimensions);
          }
        },
        listeners: {
          mousedown: 'mousedown',
          mouseup:   'mouseup',
        },
        mousedown: function(event) {
          var self = this;
        
          if (!self.isEditing) {
            
            if (event.button === 0) {
              self.fire('selected', {
                widget: self,
                mouseEvent: event,
              });
            }
            
            var cursorStartPos = {
              x: event.pageX,
              y: event.pageY,
            }
            function distance(a, b) {
              var dx = a.x - b.x;
              var dy = a.y - b.y;
              return Math.sqrt(dx*dx + dy*dy);
            }
            function handleMousemove(windowEvent) {
              var cursorPos = {
                x: windowEvent.pageX,
                y: windowEvent.pageY,
              }
              if (distance(cursorStartPos, cursorPos) > 5) {
                if (event.button === 0) {
                  self.fire('dragStart', event);
                } else if (event.button === 2) {
                  self.fire('rightButtonDragStart', {
                    widget: self,
                    mouseEvent: windowEvent,
                  });
                }
                window.removeEventListener('mousemove', handleMousemove);
                window.removeEventListener('mouseup',   handleMouseup);
              }
            }
            function handleMouseup(windowEvent) {
              window.removeEventListener('mousemove', handleMousemove);
              window.removeEventListener('mouseup',   handleMouseup);
            }
            window.addEventListener('mousemove', handleMousemove);
            window.addEventListener('mouseup',   handleMouseup);
          }
        },
        mouseup: function(event) {
          if (event.button === 2) {
            this.fire('selected', {
              widget: this,
              mouseEvent: event,
            });
            this.fire('contextMenu', event);
          }
        },
        startEditing: function() {
          this.set('isEditing', true);
          this.$.input_box.style.width = this.clientWidth + 'px';
          this.$.input_box.classList.remove('hidden');
          this.$.input_box.select();
          this.updateStyles();
          this.updateDimensions();
        },
        finishEditing: function() {
          var newName = this.$.input_box.value;
          if (newName) {
            if (this.client.web.getName(this.id_) !== newName) {
              this.client.addNames([{id: this.id_, name: newName}]);
            }
          } else {
            if (this.client.web.hasName(this.id_)) {
              this.client.removeNames([this.id_]);
            }
          }
          this.$.input_box.classList.add('hidden');
          this.set('isEditing', false);
          this.updateDimensions();
          this.fire('finishedEditing');
        },
        onBlur: function(event) {
          if (this.isEditing) {
            this.finishEditing();
          }
        },
        onKeypress: function(event) {
          if (event.which === 13) {
            this.finishEditing();
          }
        }
      });
    })();
  </script>

</dom-module>