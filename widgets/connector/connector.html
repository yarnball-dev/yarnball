<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../widget-behavior.html">

<link rel="import" href="connector-styles.html">

<dom-module id="yb-connector">
  <style include="connector-styles"></style>
  <template>
    <svg id="svg"></svg>
  </template>

  <script>
    (function() {
      'use strict';
      
      Polymer({
        is: 'yb-connector',
        behaviors: [WidgetBehavior],
        properties: {
          fromPos: { type: Object, value: null },
          viaPos:  { type: Object, value: null },
          toPos:   { type: Object, value: null },
        },
        created: function() {
          var self = this;
          require(['core/node_id'], function(node_id) {
            self.node_id = node_id;
          });
        },
        ready: function() {
          
          var self = this;
        
          var svgNS = "http://www.w3.org/2000/svg";
          self.path = document.createElementNS(svgNS, "path");
          self.path.setAttributeNS(null, 'd', self.makePathString());
          self.path.setAttributeNS(null, 'class', 'connector-path yb-connector');
          self.$.svg.appendChild(this.path);
          
          self.widgetHandle = self.path;
          
          self.path.addEventListener('mousedown', function(event) {
            self.fire('selected', {
              widget: self,
              mouseEvent: event,
            });
            if (event.button === 2) {
              self.fire('contextMenu', event);
            }
          });
        },
        link: function() {
          if (this.fromWidget &&
              this.viaWidget &&
              this.toWidget) {
            
            return {
              from: this.node_id.fromHex(this.fromWidget.nodeId),
              via:  this.node_id.fromHex(this.viaWidget.nodeId),
              to:   this.node_id.fromHex(this.toWidget.nodeId),
            }
          } else {
            return null;
          }
        },
        observers: [
          'updatePositions(fromPos, viaPos, toPos)'
        ],
        updatePositions: function(fromPos, viaPos, toPos) {
          if ('path' in this) {
            this.path.setAttributeNS(null, 'd', this.makePathString());
          }
        },
        makePathString: function() {
          if (this.fromPos !== null && this.viaPos !== null && this.toPos !== null) {
            var fromViaBend = (this.viaPos.x - this.fromPos.x) / 2;
            var viaToBend   = (this.toPos.x  - this.viaPos.x) / 2;
            return 'M' + this.fromPos.x + ',' + this.fromPos.y + ' ' +
                  'C ' + (this.fromPos.x + fromViaBend) + ',' + this.fromPos.y + ' ' +
                  (this.viaPos.x - fromViaBend) + ',' + this.viaPos.y + ' ' +
                  this.viaPos.x + ',' + this.viaPos.y + ' ' +
                  (this.viaPos.x + viaToBend) + ',' + this.viaPos.y + ' ' +
                  (this.toPos.x - viaToBend) + ',' + this.toPos.y + ' ' +
                  this.toPos.x + ',' + this.toPos.y;
          } else if (this.fromPos !== null && this.viaPos !== null) {
            var fromViaBend = (this.viaPos.x - this.fromPos.x) / 2;
            return 'M' + this.fromPos.x + ',' + this.fromPos.y + ' ' +
                  'C ' + (this.fromPos.x + fromViaBend) + ',' + this.fromPos.y + ' ' +
                  (this.viaPos.x - fromViaBend) + ',' + this.viaPos.y + ' ' +
                  this.viaPos.x + ',' + this.viaPos.y;
          } else {
            return "";
          }
        },
        highlight: function(options) {
          var color    = ('color'    in options) ? options.color    : '#fff';
          var reverse  = ('reverse'  in options) ? options.reverse  : false;
          var duration = ('duration' in options) ? options.duration : 300;
          var delay    = ('delay'    in options) ? options.delay    : 0;
          var pathLength = this.path.getTotalLength();
          var animation = this.path.animate(
            [
              {stroke: color, opacity: 1.0, 'stroke-dasharray':  pathLength, 'stroke-dashoffset': reverse ? 0           : pathLength},
              {stroke: color, opacity: 0.5, 'stroke-dasharray':  pathLength, 'stroke-dashoffset': reverse ? 0           : 0         },
              {stroke: color, opacity: 0.0, 'stroke-dasharray':  pathLength, 'stroke-dashoffset': reverse ? -pathLength : 0         },
            ],
            {
              duration: duration,
              fill: 'both',
              delay: delay,
            }
          );
          return animation.finished;
        },
      });
    })();
  </script>

</dom-module>