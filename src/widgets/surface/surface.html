<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/iron-dropdown/iron-dropdown.html">
<link rel="import" href="../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-item/paper-icon-item.html">

<link rel="import" href="../node/node.html">
<link rel="import" href="../connector/connector.html">
<link rel="import" href="../set/set.html">

<link rel="import" href="surface-styles.html">

<dom-module id="yb-surface">

  <style include="surface-styles"></style>

  <template>
  
    <div id="background" on-mousedown="backgroundMousedown"></div>
    
    <iron-dropdown id="backgroundDropdown" horizontal-align="left" vertical-align="top">
      <div class="dropdown-content">
        <paper-menu>
          <paper-icon-item on-tap="menuItem_CreateNode">
            <iron-icon icon="icons:add" item-icon></iron-icon>
            Add Node
          </paper-icon-item>
          <paper-icon-item on-tap="menuItem_CreateSet">
            <iron-icon icon="icons:add" item-icon></iron-icon>
            Add Set
          </paper-icon-item>
        </paper-menu>
      </div>
    </iron-dropdown>
    
    <iron-dropdown id="selectionDropdown" horizontal-align="left" vertical-align="top">
      <div class="dropdown-content">
        <paper-menu>
          <paper-icon-item on-tap="menuItem_DeleteSelected">
            <iron-icon icon="icons:delete" item-icon></iron-icon>
            Delete
          </paper-icon-item>
          <paper-icon-item on-tap="menuItem_CopySelected">
            <iron-icon icon="icons:content-copy" item-icon></iron-icon>
            Copy
          </paper-icon-item>
        </paper-menu>
      </div>
    </iron-dropdown>
  </template>
  
  <script>
    (function() {
      'use strict';
      
      Polymer({
        is: 'yb-surface',
        created: function() {
          var self = this;
          
          self.nodeWidgets = [];
          
          self.connectors = [];
          self.connectorsFrom = new Map();
          self.connectorsVia  = new Map();
          self.connectorsTo   = new Map();
          
          self.selectedNodeWidgets = new Set();
          self.selectedConnectors  = new Set();
          
          self.setWidgets = [];
          
          require(['client', 'node_id'], function(client, node_id) {
            self.client  = client;
            self.node_id = node_id;
          });
        },
        ready: function() {
        
          var self = this;
        
          require(['client', 'node_id'], function(client, node_id) {
            self.client  = client;
            self.node_id = node_id;
        
            self.createNodeWidget({x: 100, y: 40},  '52f9cf0e223d559931856acc98400f21');
            self.createNodeWidget({x: 100, y: 100}, '1264ed87a8274e5188f9020954811805');
            self.createNodeWidget({x: 100, y: 160}, '5c4d67cf88fd9c5dbc841dee378b6b4b');
            self.createNodeWidget({x: 185, y: 160}, '7e1b27583610201f8b48941d3637b13f');
          });
        },
        listeners: {
          contextmenu: 'oncontextmenu'
        },
        oncontextmenu: function() {
          event.preventDefault();
          return false;
        },
        getSelectors: function() {
          var selectors = [];
          this.setWidgets.forEach(function(setWidget) {
            selectors = selectors.concat(setWidget.selectors);
          });
          return selectors;
        },
        backgroundMousedown: function(event) {
          if (event.button === 0) {
            if (!event.ctrlKey) {
              this.deselect();
            }
          } else if (event.button === 2) {
            event.preventDefault();
            this.lastMenuPosition = {
              x: event.offsetX,
              y: event.offsetY,
            }
            this.$.backgroundDropdown.set('horizontalOffset', event.offsetX);
            this.$.backgroundDropdown.set('verticalOffset',   event.offsetY);
            if (!this.$.backgroundDropdown.opened) {
              this.$.backgroundDropdown.open();
            }
            return false;
          }
        },
        createNodeWidget: function(position, id) {
        
          var self = this;
        
          var nodeWidget = document.createElement('yb-node');
          if (!id) {
            id = self.node_id.makeHex();
          }
          nodeWidget.nodeId = id;
          nodeWidget.style.position = 'absolute';
          nodeWidget.style.left = position.x + 'px';
          nodeWidget.style.top  = position.y + 'px';
          nodeWidget.position = position;
          
          nodeWidget.addEventListener('dimensionsChanged', function(event) {
            self.updateConnectorsForNodeWidget(nodeWidget);
          });
          
          self._setupNodeWidgetSelection(nodeWidget);
          self._setupNodeWidgetDragging(nodeWidget);
          self._setupNodeWidgetConnectorDragging(nodeWidget);
          self._setupNodeWidgetMenu(nodeWidget);
          
          Polymer.dom(self.root).appendChild(nodeWidget);
          
          self.nodeWidgets.push(nodeWidget);
          
          return nodeWidget;
        },
        _setupNodeWidgetSelection: function(nodeWidget) {
          var self = this;
          nodeWidget.addEventListener('selected', function(event) {
            if (!self.selectedNodeWidgets.has(nodeWidget)) {
              if (!event.detail.ctrlKey) {
                self.deselect();
              }
              self.selectedNodeWidgets.add(nodeWidget);
              nodeWidget.set('selected', true);
            }
          });
        },
        deselect: function() {
          this.selectedNodeWidgets.forEach(function(nodeWidget) {
            nodeWidget.set('selected', false);
          });
          this.selectedNodeWidgets.clear();
          
          this.selectedConnectors.forEach(function(connector) {
            connector.set('selected', false);
          });
          this.selectedConnectors.clear();
        },
        deleteSelected: function() {
          var self = this;
          
          var connectorsToDelete = new Set(self.selectedConnectors);
          
          self.selectedNodeWidgets.forEach(function(nodeWidget) {
            nodeWidget.connectors().forEach(function(connector) {
              connectorsToDelete.add(connector);
            });
            Polymer.dom(self.root).removeChild(nodeWidget);
          });
          self.nodeWidgets = self.nodeWidgets.filter(function(nodeWidget) {
            return !self.selectedNodeWidgets.has(nodeWidget);
          });
          self.selectedNodeWidgets.clear();
          
          connectorsToDelete.forEach(function(connector) {
            connector.fromWidget.connectorsFrom.delete(connector);
            connector.viaWidget.connectorsVia.delete(connector);
            connector.toWidget.connectorsTo.delete(connector);
            Polymer.dom(self.root).removeChild(connector);
          });
          
          self.selectedConnectors.forEach(function(connector) {
            self.client.unsetLink(
              self.node_id.fromHex(connector.fromWidget.nodeId),
              self.node_id.fromHex(connector.viaWidget.nodeId),
              self.node_id.fromHex(connector.toWidget.nodeId)
            )
          });
          self.connectors = self.connectors.filter(function(connector) {
            return !connectorsToDelete.has(connector);
          });
          self.selectedConnectors.clear();
        },
        copySelected: function() {
          var self = this;
          
          var newNodeWidgets = new Set();
          var newConnectors  = new Set();
          
          var oldToNewNodeWidgetMap = new Map();
          
          self.selectedNodeWidgets.forEach(function(nodeWidget) {
            var newPosition = {
              x: nodeWidget.position.x + 10,
              y: nodeWidget.position.y + 10,
            }
            var newNodeWidget = self.createNodeWidget(newPosition, nodeWidget.nodeId);
            newNodeWidgets.add(newNodeWidget);
            
            nodeWidget.set('selected', false);
            newNodeWidget.set('selected', true);
            
            oldToNewNodeWidgetMap.set(nodeWidget, newNodeWidget);
          });
          
          self.selectedConnectors.forEach(function(connector) {
            
            if (self.selectedNodeWidgets.has(connector.fromWidget) &&
                self.selectedNodeWidgets.has(connector.viaWidget) &&
                self.selectedNodeWidgets.has(connector.toWidget)) {
              
              var newConnector = self.createConnector(
                oldToNewNodeWidgetMap.get(connector.fromWidget),
                oldToNewNodeWidgetMap.get(connector.viaWidget),
                oldToNewNodeWidgetMap.get(connector.toWidget)
              );
              newConnectors.add(newConnector);
              
              connector.set('selected', false);
              newConnector.set('selected', true);
            }
          });
          
          self.selectedNodeWidgets = newNodeWidgets;
          self.selectedConnectors  = newConnectors;
        },
        _setupNodeWidgetDragging: function(nodeWidget) {
        
          var self = this;
        
          nodeWidget.addEventListener('dragStart', function(event) {
          
            var surfaceRect = self.getBoundingClientRect();
            
            var cursorStartPos = {
              x: event.detail.pageX,
              y: event.detail.pageY,
            }
            
            self.selectedNodeWidgets.forEach(function(nodeWidget) {
              nodeWidget.dragStartPosition = nodeWidget.position;
            });
            
            nodeWidget.style['pointer-events'] = 'none';
            document.body.style.cursor = '-webkit-grabbing';
            function handleMousemove(event) {
            
              var cursorOffset = {
                x: event.pageX - cursorStartPos.x,
                y: event.pageY - cursorStartPos.y,
              }
              
              self.selectedNodeWidgets.forEach(function(selectedNodeWidget) {
              
                var newPos = {
                  x: selectedNodeWidget.dragStartPosition.x + cursorOffset.x,
                  y: selectedNodeWidget.dragStartPosition.y + cursorOffset.y,
                }
            
                selectedNodeWidget.style.left = newPos.x + 'px';
                selectedNodeWidget.style.top  = newPos.y + 'px';
                selectedNodeWidget.position = newPos;
              
                self.updateConnectorsForNodeWidget(selectedNodeWidget);
              });
            }
            
            function finishDragging() {
              window.removeEventListener('mousemove', handleMousemove);
              window.removeEventListener('mouseup',   finishDragging);
              document.body.style.cursor = 'default';
              nodeWidget.style['pointer-events'] = 'auto';
              
              self.getSelectors().forEach(function(selector) {
                selector.removeEventListener('mouseover', selectorMouseover);
                selector.removeEventListener('mouseout',  selectorMouseout);
                selector.removeEventListener('mouseup',   selectorMouseup);
                selector.classList.remove('drag-ready');
              });
            }
            
            window.addEventListener('mousemove', handleMousemove);
            window.addEventListener('mouseup',   finishDragging);
            
            function selectorMouseover(event) {
              var selector = event.currentTarget;
              selector.classList.add('drag-hover');
            }
            function selectorMouseout(event) {
              var selector = event.currentTarget;
              selector.classList.remove('drag-hover');
            }
            function selectorMouseup(event) {
              var selector = event.currentTarget;
              selector.classList.remove('drag-hover');
              selector.set('nodeId', nodeWidget.nodeId);
              nodeWidget.style.left = nodeWidget.dragStartPosition.x + 'px';
              nodeWidget.style.top  = nodeWidget.dragStartPosition.y + 'px';
              nodeWidget.position = nodeWidget.dragStartPosition;
              this.updateStyles();
              self.updateConnectorsForNodeWidget(nodeWidget);
              finishDragging();
            }
            
            self.getSelectors().forEach(function(selector) {
              selector.addEventListener('mouseover', selectorMouseover);
              selector.addEventListener('mouseout',  selectorMouseout);
              selector.addEventListener('mouseup',   selectorMouseup);
              selector.classList.add('drag-ready');
            });
          });
        },
        _setupNodeWidgetConnectorDragging: function(nodeWidget) {
        
          var self = this;
        
          nodeWidget.addEventListener('rightButtonDragStart', function(event) {
          
            var surfaceRect = self.getBoundingClientRect();
          
            if (!self.draggingConnector) {
              self.draggingConnector = document.createElement('yb-connector');
              Polymer.dom(self.root).appendChild(self.draggingConnector);
            }
            self.draggingConnector.set('fromPos', nodeWidget.centerPosition());
            
            self.draggingConnectorNodes = {
              from: nodeWidget,
              via:  null,
              to:   null,
            }
            
            function handleOtherNodeMouseover(event) {
              var otherNodeWidget = event.currentTarget;
              if (!self.draggingConnectorNodes.from) {
                self.draggingConnectorNodes.from = otherNodeWidget;
                self.draggingConnector.set('fromPos', otherNodeWidget.centerPosition());
              } else if (!self.draggingConnectorNodes.via) {
                if (otherNodeWidget !== self.draggingConnectorNodes.from) {
                  self.draggingConnectorNodes.via = otherNodeWidget;
                  self.draggingConnector.set('viaPos', otherNodeWidget.centerPosition());
                }
              } else if (!self.draggingConnectorNodes.to) {
                if (otherNodeWidget !== self.draggingConnectorNodes.via) {
                  self.draggingConnectorNodes.to = otherNodeWidget;
                  self.draggingConnector.set('toPos', otherNodeWidget.centerPosition());
                }
              }
            }
            
            self.nodeWidgets.forEach(function(otherNodeWidget) {
              if (otherNodeWidget !== nodeWidget) {
                otherNodeWidget.addEventListener('mouseover', handleOtherNodeMouseover);
              }
            });
            
            function handleMousemove(event) {
            
              var cursorPos = {
                x: event.pageX - surfaceRect.left,
                y: event.pageY - surfaceRect.top,
              }
              
              if (!self.draggingConnectorNodes.via) {
                self.draggingConnector.set('viaPos', cursorPos);
              } else if(!self.draggingConnectorNodes.to) {
                self.draggingConnector.set('toPos', cursorPos);
              }
            }
            function handleMouseup(event) {
              window.removeEventListener('mousemove', handleMousemove);
              window.removeEventListener('mouseup',   handleMouseup);
              
              self.nodeWidgets.forEach(function(otherNodeWidget) {
                if (otherNodeWidget !== nodeWidget) {
                  otherNodeWidget.removeEventListener('mouseover', handleOtherNodeMouseover);
                }
              });
              
              if (self.draggingConnectorNodes.from &&
                  self.draggingConnectorNodes.via &&
                  self.draggingConnectorNodes.to) {
                self.createConnector(self.draggingConnectorNodes.from,
                                     self.draggingConnectorNodes.via,
                                     self.draggingConnectorNodes.to);
                self.client.setLink(
                  self.node_id.fromHex(self.draggingConnectorNodes.from.nodeId),
                  self.node_id.fromHex(self.draggingConnectorNodes.via.nodeId),
                  self.node_id.fromHex(self.draggingConnectorNodes.to.nodeId)
                )
              }
              
              if (self.draggingConnector) {
                Polymer.dom(self.root).removeChild(self.draggingConnector);
                self.draggingConnector = null;
              }
            }
            
            window.addEventListener('mousemove', handleMousemove);
            window.addEventListener('mouseup',   handleMouseup);
          });
        },
        _setupNodeWidgetMenu: function(nodeWidget) {
          var self = this;
          nodeWidget.addEventListener('contextMenu', function(event) {
            if (!self.draggingConnector) {
              self.$.selectionDropdown.set('horizontalOffset', nodeWidget.position.x + event.detail.offsetX);
              self.$.selectionDropdown.set('verticalOffset',   nodeWidget.position.y + event.detail.offsetY);
              if (!self.$.selectionDropdown.opened) {
                self.$.selectionDropdown.open();
              }
            }
          });
        },
        createConnector: function(fromWidget, viaWidget, toWidget) {
        
          var self = this;
        
          var connector = document.createElement('yb-connector');
          Polymer.dom(self.root).appendChild(connector);
          
          connector.fromWidget = fromWidget;
          connector.viaWidget  = viaWidget;
          connector.toWidget   = toWidget;
          
          fromWidget.connectorsFrom.add(connector);
          viaWidget.connectorsVia.add(connector);
          toWidget.connectorsTo.add(connector);
          
          self.connectors.push(connector);
          
          if (!self.connectorsFrom.has(fromWidget)) {
            self.connectorsFrom.set(fromWidget, [connector]);
          } else {
            self.connectorsFrom.get(fromWidget).push(connector);
          }
          
          if (!self.connectorsVia.has(viaWidget)) {
            self.connectorsVia.set(viaWidget, [connector]);
          } else {
            self.connectorsVia.get(viaWidget).push(connector);
          }
          
          if (!self.connectorsTo.has(toWidget)) {
            self.connectorsTo.set(toWidget, [connector]);
          } else {
            self.connectorsTo.get(toWidget).push(connector);
          }
          
          connector.set('fromPos', fromWidget.centerPosition());
          connector.set('viaPos',  viaWidget.centerPosition());
          connector.set('toPos',   toWidget.centerPosition());
          
          connector.addEventListener('selected', function(event) {
            if (!self.selectedConnectors.has(connector)) {
              if (!event.detail.ctrlKey) {
                self.deselect();
              }
              self.selectedConnectors.add(connector);
              connector.set('selected', true);
            }
          });
          
          connector.addEventListener('contextMenu', function(event) {
            self.$.selectionDropdown.set('horizontalOffset', event.detail.offsetX);
            self.$.selectionDropdown.set('verticalOffset',   event.detail.offsetY);
            if (!self.$.selectionDropdown.opened) {
              self.$.selectionDropdown.open();
            }
          });
          
          return connector;
        },
        updateConnectorsForNodeWidget: function(nodeWidget) {
          if (this.connectorsFrom.has(nodeWidget)) {
            var connectorsFrom = this.connectorsFrom.get(nodeWidget);
            connectorsFrom.forEach(function(connector) {
              connector.set('fromPos', nodeWidget.centerPosition());
            });
          }
          if (this.connectorsVia.has(nodeWidget)) {
            var connectorsVia = this.connectorsVia.get(nodeWidget);
            connectorsVia.forEach(function(connector) {
              connector.set('viaPos', nodeWidget.centerPosition());
            });
          }
          if (this.connectorsTo.has(nodeWidget)) {
            var connectorsTo = this.connectorsTo.get(nodeWidget);
            connectorsTo.forEach(function(connector) {
              connector.set('toPos', nodeWidget.centerPosition());
            })
          }
        },
        menuItem_CreateNode: function() {
          this.$.backgroundDropdown.close();
          this.createNodeWidget(this.lastMenuPosition);
        },
        menuItem_CreateSet: function() {
          var self = this;
          
          self.$.backgroundDropdown.close();
          
          var setWidget = document.createElement('yb-set');
          setWidget.via = '52f9cf0e223d559931856acc98400f21';
          setWidget.to  = '7e1b27583610201f8b48941d3637b13f';
          setWidget.style.position = 'absolute';
          setWidget.style.left = self.lastMenuPosition.x + 'px';
          setWidget.style.top  = self.lastMenuPosition.y + 'px';
          setWidget.style['min-width']  = "150px";
          setWidget.style['max-width']  = "400px";
          setWidget.style['min-height'] = "50px";
          
          self.setWidgets.push(setWidget);
          
          Polymer.dom(self.root).appendChild(setWidget);
        },
        menuItem_DeleteSelected: function() {
          this.$.selectionDropdown.close();
          this.deleteSelected();
        },
        menuItem_CopySelected: function() {
          this.$.selectionDropdown.close();
          this.copySelected();
        }
      });
    })();
  </script>

</dom-module>