<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="set-styles.html">

<link rel="import" href="../selector/selector.html">

<dom-module id="yb-set">

  <style include="set-styles"></style>

  <template>
    <div id="widget-handle" class="widget-handle" on-mousedown="mousedown" on-mouseup="mouseup"></div>
    <div id="widget-body" class="widget-body">
      <div class="header">
        <yb-selector id="fromSelector" node-id="{{from}}"></yb-selector>
        <span class="connector"></span>
        <yb-selector id="viaSelector"  node-id="{{via}}"> </yb-selector>
        <span class="connector"></span>
        <yb-selector id="toSelector"   node-id="{{to}}">  </yb-selector>
      </div>
      <div id="setContent"></div>
    </div>
  </template>
  
  <script>
    (function() {
      'use strict';
      
      Polymer({
        is: 'yb-set',
        properties: {
          from: {
            type: String,
            observer: 'refreshSet',
          },
          via: {
            type: String,
            observer: 'refreshSet',
          },
          to: {
            type: String,
            observer: 'refreshSet',
          },
          selected: {
            type: Boolean,
            value: false,
            observer: 'handleSelectedChanged',
          },
        },
        created: function() {
          this.nodeWidgets      = new Set();
          this.nodeWidgetsInSet = new Map();
          
          this.selectors = new Set();
        },
        listeners: {
          nodeWidgetCreated:   'nodeWidgetCreated',
          nodeWidgetDestroyed: 'nodeWidgetDestroyed',
          selectorAttached:    'selectorAttached',
          selectorDetached:    'selectorDetached',
        },
        ready: function() {
        
          var self = this;
          
          require(['client', 'node_id'], function(client, node_id) {
            self.node_id = node_id;
            self.refreshSet();
            client.web.onLinks(function(linksAdded, linksRemoved) {
              self.updateSet(linksAdded, linksRemoved);
            });
          });
        },
        nodeWidgetCreated: function(event) {
          this.nodeWidgets.add(event.detail);
        },
        nodeWidgetDestroyed: function(event) {
          this.nodeWidgets.delete(event.detail);
        },
        selectorAttached: function(event) {
          this.selectors.add(event.detail);
        },
        selectorDetached: function(event) {
          this.selectors.delete(event.detail);
        },
        mousedown: function(event) {
          if (event.target === this.$['widget-handle'] && event.button === 0) {
            this.fire('selected',  event);
            this.fire('dragStart', event);
          }
        },
        mouseup: function(event) {
          if (event.button === 2) {
            this.fire('selected',    event);
            this.fire('contextMenu', event);
          }
        },
        handleSelectedChanged: function() {
          this.toggleClass('selected', this.selected);
        },
        filterLinks: function(links) {
          
          var self = this;
        
          if (((self.from ? 1:0) + (self.via ? 1:0) + (self.to ? 1:0)) !== 2) {
            return [];
          }
          return links.filter(function(link) {
            return (!self.from || self.node_id.toHex(link.from) === self.from) &&
                   (!self.via  || self.node_id.toHex(link.via)  === self.via) &&
                   (!self.to   || self.node_id.toHex(link.to)   === self.to);
          }).map(function(link) {
            if (!self.from) return link.from;
            if (!self.via)  return link.via;
            if (!self.to)   return link.to;
          });
        },
        refreshSet: function() {
          var self = this;
          require(['client', 'node_id'], function(client, node_id) {
            self.node_id = node_id;
            var nodeIdKeys = new Set(self.filterLinks(client.web.getLinks()).map(function(nodeId) {
              return self.node_id.toMapKey(nodeId);
            }));
            self.nodeWidgetsInSet.forEach(function(nodeWidget, nodeIdKey) {
              if (!nodeIdKeys.has(nodeIdKey)) {
                self.removeNodeWidget(self.node_id.fromMapKey(nodeIdKey));
              }
            });
            nodeIdKeys.forEach(function(nodeIdKey) {
              if (!self.nodeWidgetsInSet.has(nodeIdKey)) {
                self.addNodeWidget(self.node_id.fromMapKey(nodeIdKey));
              }
            });
          });
        },
        updateSet: function(linksAdded, linksRemoved) {
        
          var self = this;
          
          self.filterLinks(linksAdded).forEach(function(nodeId) {
            self.addNodeWidget(nodeId);
          });
          
          self.filterLinks(linksRemoved).forEach(function(nodeId) {
            self.removeNodeWidget(nodeId);
          });
        },
        addNodeWidget: function(nodeId) {
          var nodeWidget = document.createElement('yb-node');
          nodeWidget.nodeId = this.node_id.toHex(nodeId);
          Polymer.dom(this.$.setContent).appendChild(nodeWidget);
          this.nodeWidgets.add(nodeWidget);
          this.nodeWidgetsInSet.set(this.node_id.toMapKey(nodeId), nodeWidget);
        },
        removeNodeWidget: function(nodeId) {
          var nodeWidget = this.nodeWidgetsInSet.get(this.node_id.toMapKey(nodeId));
          this.nodeWidgets.delete(nodeWidget);
          this.nodeWidgetsInSet.delete(this.node_id.toMapKey(nodeId));
          Polymer.dom(this.$.setContent).removeChild(nodeWidget);
        }
      });
    })();
  </script>

</dom-module>