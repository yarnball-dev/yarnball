<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">

<link rel="import" href="../dragdrop-area/dragdrop-area.html">

<link rel="import" href="selector-styles.html">

<dom-module id="yb-selector">

  <style include="selector-styles"></style>

  <template>
    <yb-dragdrop-area id="dropTarget" on-nodes-dropped="nodesDropped">
      <template is="dom-if" if="{{nodeId}}">
        <paper-button id="clearButton" on-tap="clear">
          <iron-icon icon="icons:clear"></iron-icon>
        </paper-button>
      </template>
    </yb-dragdrop-area>
  </template>
  
  <script>
    (function() {
      'use strict';
      
      Polymer({
        is: 'yb-selector',
        properties: {
          'nodeId': {
            type: String,
            observer: 'nodeIdChanged',
            notify: true,
          },
        },
        ready: function() {
          this.classList.toggle('is-empty', this.nodeId ? false : true);
          
          this.$.dropTarget.dropRequestHandler = function(widgets) {
            return Array.from(widgets).filter(function(widget) {
              return widget.tagName === 'yb-node'.toUpperCase();
            });
          }
        
          if (this.nodeId) {
            this.nodeWidget = document.createElement('yb-node');
            this.nodeWidget.nodeId = this.nodeId;
            Polymer.dom(this.$.dropTarget).insertBefore(this.nodeWidget, Polymer.dom(this.$.dropTarget).firstChild);
          } else {
            this.nodeWidget = null;
          }
        },
        nodesDropped: function(event) {
          var nodeWidgets = Array.from(event.detail);
          if (nodeWidgets.length === 1) {
            var nodeWidget = nodeWidgets[0];
            this.set('nodeId', nodeWidget.nodeId);
          }
        },
        nodeIdChanged: function() {
        
          this.classList.toggle('is-empty', this.nodeId ? false : true);
          
          if (this.nodeWidget) {
            this.fire('nodeWidgetDetached', this.nodeWidget);
            Polymer.dom(this.$.dropTarget).removeChild(this.nodeWidget);
          }
          if (this.nodeId) {
            this.nodeWidget = document.createElement('yb-node');
            this.nodeWidget.nodeId = this.nodeId;
            Polymer.dom(this.$.dropTarget).insertBefore(this.nodeWidget, Polymer.dom(this.$.dropTarget).firstChild);
          }
          
          this.fire('nodeIdChanged', this.nodeId);
        },
        clear: function() {
          this.set('nodeId', null);
        }
      });
    })();
  </script>

</dom-module>